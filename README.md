#  Инвентори, который мы заслужили

если коротко о том, что не так с тем, что есть сейчас - его очень трудно поддерживать после появления ещё пары групп (а они уже очень нужны)

например, если добавить в группу staging/prod и ещё к ней большую consul_cluster (и в ней подгруппы с именем кластера) и ищё hw/virt, то количество групп, в которые должен быть заведен, а потом удален хост с учетом уже существующих групп становится очень большим
а так как их много - то, это заводить хост не только неудобно, но и высок шанс допустить ошибки

например:
- удалить хост не из всех групп
- положить хост в конфликтующие группы (hw + virt)
- назначить не все положенные группы (не staging, не production)

группы - это тот уровень абстракции, которые почти всегда нужен для того, чтобы играть ими в плейбуках и ролях
когда их недостаточно, гибкость пропадает

то есть "выбрать хосты в группе hw и с тегом mysql" = "выбрать хосты в группе hw и в группе mysql"
поэтому, кажется, что они не нужны
больше того, это не очень совместимо с ансиблом
то есть, нотацию с тегами в виде
- группа app, теги: staging, hw
- hosts: app@staging@hw
можно писать в совместимом с ансиблом виде с применением групп:
- hosts: app:&staging:&hw

и, наконец, что я бы хотел от внешнего инвентори:

1. возможность задавать обязательные группы (hw, virt, staging, production,...)
2. возможность ограничивать добавления хоста в конфликтующие группы: hw-virt, staging-production
3. импорт из файла
4. импорт в группы с префиксом и экспорт в консул как плюс (хосты в консуле умеют теги = группы)
5. возможность задавать обязательные группы для предка:
(если хост в consul_cluster, то он обязательно должен быть либо в consul_server, либо в consul_client)
6. обнаруживать циклические группы как плюс
(группа С включает группу А, группа A включает группу B, группа B включает группу А)
7. уметь строить граф с группами, и кто в них входит (экспортом в .svg, например)
8. экспорт в ансибло-совместимый формат (json, а не обычный inventory - обычный inventory не умеет группу, которая включает и подгруппу и хост, например)
9. уметь переменные для хостов (переменные ansible_user, ansible_shell_type, ... )
10. уметь комментарии с описанием групп

чтобы не путаться, я бы не стал добавлять переменные, которые нужны для того, чтобы проиграть плейбук во внешний инвентори: тогда станет ещё одно место с переменными, которое даже не лежит в файлике рядом с плейбуками

я посмотрел несколько решений, которые предоставляют инвентори для ансибла с хранилищем в базе (и sqlite, и в mongodb)
там все грустно - все сделано на минимальном уровне

## Необходимый минимум

- возможность задавать обязательные группы (hw, virt, staging, production,...)
- возможность ограничивать добавления хоста в конфликтующие группы: hw/virt, staging/production, dc1/dc2
- возможность задавать обязательные группы для предка:
(если хост в consul_cluster, то он обязательно должен быть либо в consul_server, либо в consul_client и либо consul-agent, либо consul-server)

